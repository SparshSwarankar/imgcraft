{% extends "base.html" %}

{% block title %}Login & Sign Up – ImgCraft{% endblock %}

{% block meta_description %}Sign in to your ImgCraft account to access premium AI image tools and manage your credits
securely.{% endblock %}

{% block og_title %}Login & Sign Up – ImgCraft{% endblock %}
{% block og_description %}Access your account to unlock premium features. Sign up free and start editing images with
AI-powered tools.{% endblock %}

{% block head %}
<style>
    /* Modern Auth Page */
    body.auth-page {
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        overflow-x: hidden;
    }

    body {
        min-height: 0 !important;
    }

    .auth-wrapper {
        min-height: calc(100vh - 50px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        position: relative;
        margin-top: 50px;
    }

    /* Background animation */
    .auth-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }

    .auth-blob {
        position: absolute;
        border-radius: 50%;
        opacity: 0.1;
        animation: float 8s ease-in-out infinite;
    }

    .auth-blob:nth-child(1) {
        width: 300px;
        height: 300px;
        background: var(--primary-color);
        top: 10%;
        right: 10%;
        animation-delay: 0s;
    }

    .auth-blob:nth-child(2) {
        width: 250px;
        height: 250px;
        background: var(--secondary-color);
        bottom: 20%;
        left: 5%;
        animation-delay: 2s;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0px);
        }

        50% {
            transform: translateY(-20px);
        }
    }

    .auth-container {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 30px;
        padding: 3rem 2rem;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.6s ease;
        position: relative;
        z-index: 10;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .auth-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    /* .auth-logo {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 0.5rem;
        letter-spacing: -1px;
    } */

    .auth-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
    }

    .auth-subtitle {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.95rem;
        margin-bottom: 2rem;
    }

    .auth-tabs {
        display: flex;
        margin-bottom: 2.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        gap: 1rem;
    }

    .auth-tab {
        flex: 1;
        text-align: center;
        padding: 1rem 0;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.5);
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 1rem;
        border-bottom: 3px solid transparent;
        position: relative;
        bottom: -1px;
    }

    .auth-tab:hover {
        color: rgba(255, 255, 255, 0.8);
    }

    .auth-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .auth-form {
        display: none;
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .auth-form.active {
        display: block;
    }

    .form-group {
        margin-bottom: 1.8rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.7rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
        font-weight: 500;
    }

    .form-input {
        width: 100%;
        padding: 0.9rem 1.1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1.5px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .form-input:hover {
        border-color: rgba(255, 255, 255, 0.2);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .btn-submit {
        width: 100%;
        padding: 1.1rem;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1.5rem;
        box-shadow: 0 10px 25px rgba(255, 107, 107, 0.2);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(255, 107, 107, 0.3);
    }

    .btn-submit:active {
        transform: translateY(0);
    }

    .btn-submit:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    .auth-footer {
        margin-top: 1.8rem;
        text-align: center;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .auth-footer a {
        color: var(--primary-color);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .auth-footer a:hover {
        color: var(--secondary-color);
        text-decoration: underline;
    }

    .auth-divider {
        display: flex;
        align-items: center;
        margin: 2rem 0;
        gap: 1rem;
    }

    .auth-divider::before,
    .auth-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
    }

    .auth-divider-text {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85rem;
    }

    .auth-social {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .btn-social {
        padding: 0.9rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .btn-social:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .alert {
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 12px;
        font-size: 0.9rem;
        display: none;
    }

    .alert.show {
        display: block;
    }

    .alert-error {
        background: rgba(255, 71, 87, 0.15);
        border: 1px solid rgba(255, 71, 87, 0.3);
        color: #ff4757;
    }

    .alert-success {
        background: rgba(46, 204, 113, 0.15);
        border: 1px solid rgba(46, 204, 113, 0.3);
        color: #2ecc71;
    }

    @media (max-width: 768px) {
        .auth-wrapper {
            min-height: calc(100vh - 70px);
            padding: 1.5rem 1rem;
            margin-top: 70px;
        }

        .auth-container {
            padding: 2rem 1.5rem;
            max-width: 95%;
            border-radius: 20px;
        }

        .auth-header {
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 1.6rem;
        }

        .auth-logo {
            font-size: 2rem;
            margin-bottom: 0.3rem;
        }

        .auth-subtitle {
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            font-size: 0.85rem;
        }

        .form-input {
            padding: 0.9rem 1rem;
            font-size: 1rem;
        }

        .btn-submit {
            padding: 0.95rem;
            font-size: 0.95rem;
            margin-top: 1rem;
        }

        .auth-tab {
            padding: 0.8rem 0;
            font-size: 0.9rem;
        }

        .btn-social {
            padding: 0.8rem;
            font-size: 0.85rem;
        }

        .auth-blob {
            width: 150px;
            height: 150px;
        }
    }

    @media (max-width: 480px) {
        .auth-wrapper {
            min-height: calc(100vh - 60px);
            padding: 1rem;
            margin-top: 60px;
        }

        .auth-container {
            padding: 1.5rem 1rem;
            border-radius: 18px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .auth-header {
            margin-bottom: 1.5rem;
        }

        .auth-title {
            font-size: 1.4rem;
            margin-bottom: 0.3rem;
        }

        .auth-logo {
            font-size: 1.8rem;
            margin-bottom: 0.2rem;
        }

        .auth-subtitle {
            font-size: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .auth-tabs {
            margin-bottom: 2rem;
            gap: 0.5rem;
        }

        .auth-tab {
            padding: 0.7rem 0;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 0.9rem;
        }

        .form-label {
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .form-input {
            padding: 0.8rem 0.9rem;
            font-size: 1rem;
            border-radius: 10px;
        }

        .form-input::placeholder {
            font-size: 0.9rem;
        }

        .btn-submit {
            width: 100%;
            padding: 0.85rem;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            border-radius: 10px;
        }

        .btn-social {
            padding: 0.7rem;
            font-size: 0.75rem;
            border-radius: 10px;
        }

        .alert {
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            font-size: 0.85rem;
        }

        .auth-divider {
            margin: 1.5rem 0;
            gap: 0.8rem;
        }

        .auth-divider-text {
            font-size: 0.75rem;
        }

        .auth-footer {
            margin-top: 1.2rem;
            font-size: 0.8rem;
        }

        .auth-blob {
            width: 100px;
            height: 100px;
            opacity: 0.08;
        }

        .auth-blob:nth-child(1) {
            width: 150px;
            height: 150px;
            top: 5%;
        }

        .auth-blob:nth-child(2) {
            width: 120px;
            height: 120px;
            bottom: 10%;
        }
    }

    @media (max-width: 360px) {
        .auth-container {
            padding: 1.2rem 0.8rem;
        }

        .auth-title {
            font-size: 1.2rem;
        }

        .auth-logo {
            font-size: 1.6rem;
        }

        .form-input {
            padding: 0.7rem 0.8rem;
            font-size: 0.95rem;
        }

        .btn-submit {
            padding: 0.75rem;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-bg">
    <div class="auth-blob"></div>
    <div class="auth-blob"></div>
</div>

<div class="auth-wrapper">
    <div class="auth-container">
        <div class="auth-header">
            <!-- <div class="auth-logo"></div> -->
            <h1 class="auth-title">ImgCraft</h1>
            <p class="auth-subtitle">Your Ultimate Image Editing Tool</p>
        </div>

        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchTab(event, 'login')">
                <i class="fas fa-sign-in-alt"></i> Login
            </div>
            <div class="auth-tab" onclick="switchTab(event, 'signup')">
                <i class="fas fa-user-plus"></i> Sign Up
            </div>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
            <div id="loginAlert" class="alert"></div>

            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" name="email" required placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" name="password" required placeholder="••••••••">
            </div>

            <button type="submit" class="btn-submit">
                <i class="fas fa-sign-in-alt"></i> Login to ImgCraft
            </button>

            <div class="auth-footer">
                <a href="#" onclick="switchTab(event, 'forgot')"><i class="fas fa-question-circle"></i> Forgot your
                    password?</a>
            </div>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
            <div id="signupAlert" class="alert"></div>

            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" name="fullName" required placeholder="John Doe">
            </div>

            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" name="email" required placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" name="password" required minlength="6" placeholder="••••••••">
            </div>

            <button type="submit" class="btn-submit">
                <i class="fas fa-user-plus"></i> Create Free Account
            </button>

            <div class="auth-footer">
                By signing up, you agree to our<br>
                <a href="#">Terms & Conditions</a> and <a href="#">Privacy Policy</a>
            </div>
        </form>

        <!-- Forgot Password Form -->
        <form id="forgotForm" class="auth-form" onsubmit="handleForgotPassword(event)">
            <div id="forgotAlert" class="alert"></div>

            <div id="forgotRequestSection">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="forgotEmail" name="email" required
                        placeholder="your@email.com">
                </div>

                <button type="submit" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> Send Reset Link
                </button>

                <div class="auth-footer">
                    Remember your password? <a href="#" onclick="switchTab(event, 'login')">Login</a>
                </div>
            </div>

            <div id="forgotResetSection" style="display: none;">
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="newPassword" name="newPassword" minlength="6"
                        placeholder="••••••••">
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" name="confirmPassword" minlength="6"
                        placeholder="••••••••">
                </div>

                <button type="button" class="btn-submit" onclick="handleResetPassword(event)">
                    <i class="fas fa-lock"></i> Reset Password
                </button>

                <div class="auth-footer">
                    <a href="#" onclick="switchTab(event, 'login')">Back to Login</a>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize auth forms with skeleton loading effect
    document.addEventListener('DOMContentLoaded', () => {
        // Show skeleton briefly while forms initialize
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');

        // Create skeleton overlay
        const skeletonOverlay = document.createElement('div');
        skeletonOverlay.className = 'skeleton-auth-overlay';
        skeletonOverlay.innerHTML = `
            <div class="skeleton-auth-container">
                <div class="skeleton skeleton-heading"></div>
                <div style="margin-top: 1rem;">
                    ${Array(3).fill(0).map(() => `
                        <div class="skeleton-form-group">
                            <div class="skeleton skeleton-form-label"></div>
                            <div class="skeleton skeleton-form-input"></div>
                        </div>
                    `).join('')}
                </div>
                <div class="skeleton skeleton-form-button"></div>
            </div>
        `;

        // Insert skeleton overlay before forms
        const authContainer = document.querySelector('.auth-container');
        authContainer.insertBefore(skeletonOverlay, loginForm);

        // Remove skeleton after brief delay to show forms
        setTimeout(() => {
            skeletonOverlay.style.animation = 'fade-out-skeleton 0.3s ease-out forwards';
            setTimeout(() => {
                skeletonOverlay.remove();
            }, 300);
        }, 500);
    });

    function switchTab(event, tab) {
        event.preventDefault();

        // Update tabs (only if clicking on a tab element)
        if (event.target.closest('.auth-tab')) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            event.target.closest('.auth-tab').classList.add('active');
        }

        // Update forms
        document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));
        document.getElementById(tab + 'Form').classList.add('active');
    }

    function showAlert(formId, message, type) {
        const alertEl = document.getElementById(formId + 'Alert');
        alertEl.textContent = message;
        alertEl.className = `alert show alert-${type}`;
    }

    async function handleLogin(e) {
        e.preventDefault();
        const form = e.target;
        const email = form.email.value;
        const password = form.password.value;
        const btn = form.querySelector('button');

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';

            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!data.success) throw new Error(data.error);

            // Store tokens in localStorage so Supabase client can access them
            if (data.access_token && data.refresh_token) {
                const session = {
                    access_token: data.access_token,
                    refresh_token: data.refresh_token,
                    expires_in: 3600,
                    expires_at: Math.floor(Date.now() / 1000) + 3600,
                    token_type: 'bearer',
                    type: 'signup',
                    user: data.user
                };

                // Store in localStorage exactly as Supabase expects
                localStorage.setItem('sb-' + window.SUPABASE_URL.split('//')[1].split('.')[0] + '-auth-token', JSON.stringify(session));
            }

            showAlert('login', '✓ Login successful! Redirecting...', 'success');

            // Wait a bit for AuthManager to process the session change
            setTimeout(() => {
                window.location.href = '/';
            }, 500);

        } catch (error) {
            // Check if this is an email verification error
            const errorMessage = error.message || 'Login failed';

            if (errorMessage.includes('verify your email') || errorMessage.includes('email_not_verified')) {
                showAlert('login', '⚠️ Email Not Verified!\n\nPlease check your inbox and click the verification link before logging in. Check your spam folder if you don\'t see it.', 'error');
            } else {
                showAlert('login', '✗ ' + errorMessage, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to ImgCraft';
        }
    }

    async function handleSignup(e) {
        e.preventDefault();
        const form = e.target;
        const email = form.email.value;
        const password = form.password.value;
        const fullName = form.fullName.value;
        const btn = form.querySelector('button');

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, full_name: fullName })
            });

            const data = await response.json();

            if (!data.success) throw new Error(data.error);

            showAlert('signup', '✓ Account created! Check your email for verification.', 'success');

            // Optionally auto-login if no email verification needed
            setTimeout(() => {
                form.reset();
                // Optionally redirect after delay
                // window.location.href = '/';
            }, 2000);

        } catch (error) {
            showAlert('signup', '✗ ' + (error.message || 'Signup failed'), 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Free Account';
        }
    }

    async function handleForgotPassword(e) {
        e.preventDefault();
        const form = e.target;
        const email = form.email.value;
        const btn = form.querySelector('button[type="submit"]');

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            const response = await fetch('/api/auth/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (!data.success) throw new Error(data.error);

            showAlert('forgot', '✓ Password reset link sent! Check your email.', 'success');

            setTimeout(() => {
                form.reset();
            }, 2000);

        } catch (error) {
            showAlert('forgot', '✗ ' + (error.message || 'Failed to send reset link'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reset Link';
        }
    }

    async function handleResetPassword(e) {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const btn = e.target;

        // Validate passwords match
        if (newPassword !== confirmPassword) {
            showAlert('forgot', '✗ Passwords do not match', 'error');
            return;
        }

        if (newPassword.length < 6) {
            showAlert('forgot', '✗ Password must be at least 6 characters', 'error');
            return;
        }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

            // Get reset token from URL query params (our custom system)
            const queryParams = new URLSearchParams(window.location.search);
            const resetToken = queryParams.get('reset_token');

            console.log('Reset token found:', resetToken ? 'Yes' : 'No');
            console.log('Search:', window.location.search);

            if (!resetToken) {
                throw new Error('Invalid or expired reset link. Please request a new one.');
            }

            const response = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reset_token: resetToken,
                    password: newPassword
                })
            });

            const data = await response.json();

            if (!data.success) throw new Error(data.error);

            showAlert('forgot', '✓ Password reset successful! Redirecting to login...', 'success');

            setTimeout(() => {
                // Clear URL params and switch to login
                window.history.replaceState({}, document.title, window.location.pathname);
                switchTab({ target: document.querySelector('.auth-tab'), preventDefault: () => { } }, 'login');
            }, 2000);

        } catch (error) {
            showAlert('forgot', '✗ ' + (error.message || 'Failed to reset password'), 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-lock"></i> Reset Password';
        }
    }



    // URL Parameter handling (Verification, Password Reset, and Errors)
    document.addEventListener('DOMContentLoaded', () => {
        const queryParams = new URLSearchParams(window.location.search);
        const resetToken = queryParams.get('reset_token');
        const isVerified = queryParams.get('verified') === 'true';
        const errorMsg = queryParams.get('error');

        // 1. Handle Email Verification Success
        if (isVerified) {
            showAlert('login', '✓ Email verified successfully! You can now log in.', 'success');
            // Clean up the URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // 2. Handle Errors (e.g. invalid token)
        if (errorMsg) {
            showAlert('login', '✗ ' + decodeURIComponent(errorMsg), 'error');
            // Clean up the URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // 3. Handle Password Reset Token Detection (Auto-switch to reset form)
        if (resetToken) {
            // Hide all forms and tabs
            document.querySelectorAll('.auth-form').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));

            // Show reset password section
            document.getElementById('forgotForm').classList.add('active');
            document.getElementById('forgotRequestSection').style.display = 'none';
            document.getElementById('forgotResetSection').style.display = 'block';

            showAlert('forgot', 'Enter your new password below', 'success');
        }
    });
</script>
{% endblock %}